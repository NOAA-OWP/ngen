<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NGen: Python Routing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NGen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2_p_y_t_h_o_n___r_o_u_t_i_n_g.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Python Routing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md211"></a> </p>
<h1><a class="anchor" id="autotoc_md212"></a>
Summary</h1>
<p><a href="https://github.com/NOAA-OWP/t-route">t-route</a> is the routing framework developed by NOAA-OWP.</p>
<p>See <a href="DEPENDENCIES.md#t-route">Setting up t-route source</a> for details on aquiring the t-route submodule. You will also need to <a href="DEPENDENCIES.md#pybind11">set up pybind11</a> to use t-route.</p>
<h1><a class="anchor" id="autotoc_md213"></a>
Setup Virtual Environment</h1>
<p>Since t-route is set of Python modules, it will need to be installed in the Python environment ngen will be running with. Below are recommended steps to accomplish this:</p>
<ol type="1">
<li>From the ngen project root (if this virtual environment exists, you may skip this step.)</li>
</ol>
<div class="fragment"><div class="line">python3 -m venv venv</div>
</div><!-- fragment --><ol type="1">
<li>Activate the virtual environment and install/update a few prerequisites:</li>
</ol>
<div class="fragment"><div class="line">source venv/bin/activate</div>
<div class="line">pip install -U pip deprecated pyarrow geopandas tables</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md214"></a>
Install t-route</h1>
<p><a href="https://github.com/NOAA-OWP/t-route#usage-and-testing">Compile and install t-route</a> following the instructions from the t-route repository. Ensure that you install the t-route modules in the virtual environment from step 2 of the Setup Virtual Environment section. The t-route source can be downloaded and placed anywhere, it is only important that the Python modules are installed in the right virtual environment.</p>
<h1><a class="anchor" id="autotoc_md215"></a>
Installation Caveats</h1>
<h2><a class="anchor" id="autotoc_md216"></a>
Compilers and Libraries</h2>
<p>The t-route compiler script, <code>compiler.sh</code>, compiles and links <code>C</code> and <code>Fortran</code> code that will run <em>within</em> an <code>ngen</code> process. Ensure that compiler paths and flags, include paths, library paths, and other build time environment variables match the settings used to compile <code>ngen</code> to avoid conflicting dependencies and undefined behavior.</p>
<p>Note, the t-route extension modules rely on netcdf fortran, and thus they need to be compiled with the same fortran compiler that compiled the netcdf library. For example, if <code>libnetcdff</code> was provided by the RHEL7 package <code>netcdf-fortran-openmpi-static-4.2-16.el7.x86_64</code> which was compiled with the openmpi fortran compiler, you will have to set the <code>FC</code> environment variable appropriately before executing the t-route <code>compiler.sh</code> script, like so:</p>
<div class="fragment"><div class="line">FC=mpif90 ./compiler.sh</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md217"></a>
Default installation is in development mode (impacts macOS)</h2>
<p>The <code>compiler.sh</code> script will install the Python modules with <code>-e</code>. On macOS, you may need to re-install the modules in t-route's <code>src</code> directory directly after running <code>compiler.sh</code>.</p>
<h2><a class="anchor" id="autotoc_md218"></a>
Some tips on installation if you run into issues</h2>
<ul>
<li><a href="https://github.com/Unidata/netcdf4-python/issues/1296">On install mpi4py</a></li>
<li><a href="https://github.com/NOAA-OWP/t-route/issues/621">On pip version</a></li>
<li><a href="https://github.com/NOAA-OWP/t-route/issues/705">On NetCDF version</a></li>
</ul>
<p><a href="https://github.com/NOAA-OWP/t-route#configuration-and-dependencies">Additional documentation for configuration and dependencies of t-route</a>.</p>
<h1><a class="anchor" id="autotoc_md219"></a>
Using t-route with ngen</h1>
<ul>
<li><p class="startli">Create the build directory including the options to activate Python and Routing:</p><ul>
<li>Activate Python flag with <code>-DNGEN_WITH_PYTHON:BOOL=ON</code></li>
<li>Activate Routing flag with <code>-DNGEN_WITH_ROUTING:BOOL=ON.</code> <br  />
</li>
<li>An example create build directory command with the above two options activated:</li>
</ul>
<p class="startli"><code>sh cmake -B cmake_build -DNGEN_WITH_PYTHON:BOOL=ON -DNGEN_WITH_ROUTING:BOOL=ON -DNGEN_WITH_TESTS:BOOL=ON . </code> <br  />
</p>
</li>
<li><p class="startli">Unit tests for the Routing_Py_Adapter class can then be built and run from the main directory with the following two commands:</p>
<p class="startli"><code>sh cmake --build cmake_build --target test_routing_pybind ./cmake-build-debug/test/test_routing_pybind </code></p>
</li>
<li>An <a href="../data/gauge_01073000/example_bmi_multi_realization_config_w_routing.json">example realization config</a> with routing inputs.</li>
</ul>
<h2><a class="anchor" id="autotoc_md220"></a>
Realization Config</h2>
<p>To enable routing in a simulation realization config file, a <code>routing</code> block should appear with a path to the t-route configuration file at the same level as the <code>time</code> configuration, like so:</p>
<div class="fragment"><div class="line">...</div>
<div class="line">&quot;time&quot;: {</div>
<div class="line">    &quot;start_time&quot;: &quot;2015-12-01 0:00:00&quot;,</div>
<div class="line">    &quot;end_time&quot;: &quot;2015-12-30 23:00:00&quot;,</div>
<div class="line">    &quot;output_interval&quot;: 3600</div>
<div class="line">},</div>
<div class="line">&quot;routing&quot;: {</div>
<div class="line">    &quot;t_route_config_file_with_path&quot;: &quot;./data/gauge_01073000/routing_config.yaml&quot;</div>
<div class="line">}</div>
<div class="line">...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md221"></a>
Routing Config</h2>
<p>t-route uses a yaml input file for configuring the routing setup, see the <a href="https://github.com/NOAA-OWP/t-route#configuration">t-route repo documentation</a> for more information. An <a href="../data/gauge_01073000/routing_config.yaml">example configuration</a> file is included in the example data.</p>
<h2><a class="anchor" id="autotoc_md222"></a>
Configuration considerations for t-route with ngen</h2>
<p>Output from ngen is currently created on an hourly basis and in files per nexus, which is different from t-route's native processing expectations. To account for this, currently t-route preprocesses the ngen nexus output CSV files before running. To ensure this happens correctly, these settings <em>must</em> be correct in the configuration YAML:</p>
<div class="fragment"><div class="line"># These examples assume a 720h (30 day) simulation:</div>
<div class="line">forcing_parameters:</div>
<div class="line">    # t-route&#39;s internal timestep in seconds</div>
<div class="line">    dt                          : 300</div>
<div class="line">    # ngen&#39;s timestep divided by t-route&#39;s (e.g. 3600/300)</div>
<div class="line">    qts_subdivisions            : 12 </div>
<div class="line">    # total simulation t-route timesteps (e.g. 12 per hour, 288 per day)</div>
<div class="line">    nts                         : 8640</div>
<div class="line">    # number of external (ngen) timesteps</div>
<div class="line">    max_loop_size               : 720</div>
<div class="line">    # The location to find the nex-* CSV files</div>
<div class="line">    qlat_input_folder           : ./ </div>
<div class="line">    nexus_input_folder          : ./</div>
<div class="line">    # The glob pattern to match nexus output files - MUST NOT CHANGE!</div>
<div class="line">    qlat_file_pattern_filter    : &quot;nex-*&quot;</div>
<div class="line">    nexus_file_pattern_filter   : &quot;nex-*&quot;</div>
<div class="line">    # A directory where the temporary *.parquet files will be stored</div>
<div class="line">    binary_nexus_file_folder    : /tmp</div>
</div><!-- fragment --><p> IMPORTANT: See the #known-issues below!</p>
<h1><a class="anchor" id="autotoc_md223"></a>
Running t-route separately with ngen output</h1>
<p>In some cases it may be useful to run the routing step separately. To do so, after installing t-route in your environment as described above, execute it directly this way:</p>
<div class="fragment"><div class="line">python -m nwm_routing -V4 -f /path/to/routing_config.yaml</div>
</div><!-- fragment --><p>This is particularly useful if a long simulation completes in ngen but fails in t-route. Running routing this way will also often give more detailed error messages, if you are experiencing problems during the routing phase.</p>
<h1><a class="anchor" id="autotoc_md224"></a>
Known issues</h1>
<h2><a class="anchor" id="autotoc_md225"></a>
Cleanup of &lt;tt&gt;*.parquet&lt;/tt&gt; files required</h2>
<p>Running t-route with ngen <code>nex-*.csv</code> input will generate hourly files with names matching <code>*.parquet</code> in the directory specified by <code>binary_nexus_file_folder</code> but it <em>does not remove them after the simulation compeltes</em>, and the presence of these files will prevent t-route from running. To run a simulation a second time, you will need to manually remove the created <code>*.parquet</code> files.</p>
<h2><a class="anchor" id="autotoc_md226"></a>
Bug in multiprocessing on macOS</h2>
<p>It is not currently possible to use multiprocessing in t-route on macOS as part of an ngen simulation directly. To use routing on macOS, either:</p>
<ol type="1">
<li>Run t-route in ngen with the <code>routing</code> block in the realization config and ensure that the t-route configuration specifies <code>cpu_pool: 1</code> to disable multiprocessing,</li>
</ol>
<p>OR</p>
<ol type="1">
<li>Run t-route separately, after the ngen simulation as described above.</li>
</ol>
<p>At present, running within ngen with <code>cpu_pool</code> &gt; 1 will result in spawning many additional ngen processes, consuming lots of resources and likely corrupting your output! See #505 . </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Jun 26 2024 16:30:04 for NGen by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
