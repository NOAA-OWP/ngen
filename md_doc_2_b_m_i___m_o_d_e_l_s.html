<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NGen: BMI External Models</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NGen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2_b_m_i___m_o_d_e_l_s.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">BMI External Models</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md28"></a></p><ul>
<li>BMI External Models<ul>
<li>Summary</li>
<li>Formulation Config<ul>
<li>Required Parameters<ul>
<li>Parameter Details:</li>
</ul>
</li>
<li>Semi-Optional Parameters</li>
<li>Optional Parameters</li>
</ul>
</li>
<li>BMI Models Written in C<ul>
<li>BMI C Model As Shared Library<ul>
<li>Dynamic Loading</li>
</ul>
</li>
<li>BMI C CFE Example</li>
<li>BMI C Caveats<ul>
<li>BMI C Activate/Deactivation Required in CMake Build</li>
<li>Additional Bootstrapping Function Needed<ul>
<li>Why?</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>BMI Models Written in C++<ul>
<li>BMI C++ Model As Shared Library<ul>
<li>Dynamic Loading</li>
<li>Additional Bootstrapping Functions Needed<ul>
<li>Why?</li>
</ul>
</li>
</ul>
</li>
<li>BMI C++ Example</li>
</ul>
</li>
<li>BMI Models Written in Fortran<ul>
<li>Enabling Fortran Integration</li>
<li>ISO C Binding Middleware</li>
<li>A Compiled Shared Library<ul>
<li>Required Additional Fortran Registration Function</li>
</ul>
</li>
</ul>
</li>
<li>BMI Models Written in Python<ul>
<li>Enabling Python Integration</li>
<li>BMI Python Model as Package Class</li>
<li>BMI Python Example</li>
</ul>
</li>
<li>Multi-Module BMI Formulations<ul>
<li>Passing Variables Between Nested Formulations<ul>
<li>How Values Are Orchestrated</li>
<li>Look-back and Default Values</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md29"></a>
Summary</h1>
<p>The basic outline of steps needed to work with an external BMI model is:</p><ul>
<li>Configure the main formulation/realization config properly for the catchments that will use the generalized BMI realization(s)</li>
<li>Make sure all the necessary model-specific BMI initialization files are valid and in place</li>
<li>Take appropriate steps to make model source files accessible as needed (e.g., making sure shared library files are in a known location)</li>
<li>Be aware of any model-language-specific caveats<ul>
<li>Caveats for C language models</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md30"></a>
Formulation Config</h1>
<p>The catchment entry in the formulation/realization config must be set to used the appropriate type for the associated BMI realization, via the formulation's <code>name</code> JSON element. E.g.:</p>
<div class="fragment"><div class="line">//...</div>
<div class="line">&quot;cat-87&quot;: {</div>
<div class="line">     &quot;formulations&quot;: [</div>
<div class="line">         {</div>
<div class="line">             &quot;name&quot;: &quot;bmi_c&quot;,</div>
<div class="line">             &quot;params&quot;: { ... }</div>
<div class="line">         }</div>
<div class="line">     }</div>
<div class="line">//...</div>
</div><!-- fragment --><p>Valid name values for the currently implemented BMI formulation types are:</p>
<ul>
<li><code>bmi_c++</code></li>
<li><code>bmi_c</code></li>
<li><code>bmi_fortran</code></li>
<li><code>bmi_python</code></li>
<li><code>bmi_multi</code></li>
</ul>
<p>Because of the generalization of the interface to the model, the required and optional parameters for all the BMI formulation types are the same.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Required Parameters</h2>
<p>Certain parameters are strictly required in the formulation/realization JSON config for a catchment entry using a BMI formulation type. Note that there is a slight distinction in "required" between single-module (e.g., <code>bmi_c</code>) and multi-module formulations (i.e., <code>bmi_multi</code>). These are summarized in the following table, with the details of the parameters list below.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Param   </th><th class="markdownTableHeadNone">Single-Module   </th><th class="markdownTableHeadNone">Multi-Module    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>model_type_name</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone">:heavy_check_mark:    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>init_config</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>uses_forcing_file</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>main_output_variable</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone">:heavy_check_mark:    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>modules</code>   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">:heavy_check_mark:   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md32"></a>
Parameter Details:</h4>
<ul>
<li><code>model_type_name</code><ul>
<li>string name for the particular backing model type</li>
<li>may not be utilized in all cases, but still required</li>
</ul>
</li>
<li><code>init_config</code><ul>
<li>the string path to the BMI initialization config file for the catchment</li>
</ul>
</li>
<li><code>uses_forcing_file</code><ul>
<li>boolean indicating whether the backing BMI model is written to read input forcing data from a forcing file (as opposed to receiving it via getters calls made by the framework)</li>
</ul>
</li>
<li><code>main_output_variable</code><ul>
<li>the name of the BMI variable returned by the catchment formulation's <code>get_response()</code> function</li>
<li>this is colloquially referred to as the "main" output from the formulation, but is not directly related to catchment output files<ul>
<li>see details on the optional <code>output_variables</code> config parameter for configuring output</li>
</ul>
</li>
<li>the string must match an item return by the relevant variant of the BMI <code>get_output_var_names()</code> function</li>
</ul>
</li>
<li><code>modules</code><ul>
<li>a list of individual formulation configs for component modules of a BMI multi-module formulation</li>
<li>each item in the list will be another nested JSON config object for a BMI formulation</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md33"></a>
Semi-Optional Parameters</h2>
<p>There are some special BMI formulation config parameters which are required in certain circumstances, but which are neither <em>always</em> required nor required for either all single- or multi-module formulations. Thus, they do not behave exactly as <em>Required</em> params do in the configuration. However, they should be thought of as de facto required (and will trigger errors when missing) in the specific situations in which they are applicable.</p>
<ul>
<li><code>forcing_file</code><ul>
<li>string path to the forcing data file for the catchment</li>
<li>must be set whenever a model needs to read its own forcings directly<ul>
<li>this is set/indicated using <code>uses_forcing_file</code> as described above</li>
</ul>
</li>
<li>the BMI model's initialization config (i.e., <code>init_config</code> above) may define an analogous property, and the two should properly correspond in such cases</li>
</ul>
</li>
<li><code>library_file</code><ul>
<li>Path to the library file for the BMI library</li>
<li>Required for C-based BMI model formulations</li>
</ul>
</li>
<li><code>registration_function</code><ul>
<li>Name of the bootstrapping pointer registration function in the external module</li>
<li>required for C-based BMI modules if the module's implemented function is not named <code>register_bmi</code> as discussed here</li>
<li>only needed for C-based BMI modules</li>
</ul>
</li>
<li><code>python_type</code><ul>
<li>Name of the Python class that represents a BMI model, including the package name as appropriate.</li>
<li>Required for Python-based BMI modules</li>
<li>Only needed for Python-based modules</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md34"></a>
Optional Parameters</h2>
<ul>
<li><code>variables_names_map</code><ul>
<li>can specify a mapping of one or more model variable names (input or output) to aliases used as a recognizable identifiers for those variables within the framework<ul>
<li>e.g., <code>"variables_names_map": {"bmi_var_name_1": "framework_alias_1", "bmi_var_name_2": "framework_alias_2"}</code></li>
</ul>
</li>
<li>commonly, this is used to map a module's BMI variable names to standard names<ul>
<li>this kind of mapping is often necessary to inform the framework how to provide an input - e.g., a forcings value - that a BMI module needs for execution</li>
<li>the <a href="../include/forcing/AorcForcing.hpp">AorcForcing.hpp</a> file has a section where several supported standard names are defined and notes <br  />
</li>
<li>these typically conform to <a href="https://csdms.colorado.edu/wiki/CSDMS_Standard_Names">CSDMS Standard Names</a></li>
</ul>
</li>
</ul>
</li>
<li><code>model_params</code><ul>
<li>can specify static or dynamic parameters passed to models as model variables.</li>
<li>static parameters are defined inline in the realization config.</li>
<li>dynamic parameters are derived from a given source, such as hydrofabric data.</li>
<li>if specified, must be within the <b>params</b> config level, i.e. within a <code>"formulations": [..., {..., "params": {..., "model_params": {...}, ...}, ...}, ...]</code> object.</li>
<li>if specified for multi-BMI, must be within the <b>module-params</b> config level, i.e. in the <b>params</b> config level for a given <b>module</b>.</li>
<li>e.g., <div class="fragment"><div class="line">// Format: { &lt;variable_name&gt;: &lt;value&gt; }</div>
<div class="line">&quot;model_params&quot;: {</div>
<div class="line">  // Static parameter</div>
<div class="line">  &quot;APCP_Surface&quot;: 3.0,</div>
<div class="line"> </div>
<div class="line">  // Dynamic parameter</div>
<div class="line">  &quot;areasqkm&quot;: {</div>
<div class="line">    // where this variable is deriving from, only &quot;hydrofabric&quot; is supported currently</div>
<div class="line">    &quot;source&quot;: &quot;hydrofabric&quot;,</div>
<div class="line">    // the property name of this value,</div>
<div class="line">    // i.e. what property (area_sqkm) in the source (hydrofabric) maps to our variable (areasqkm)?</div>
<div class="line">    &quot;from&quot;: &quot;area_sqkm&quot;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><code>output_variables</code><ul>
<li>can specify the particular set and order of output variables to include in the realization's <code>get_output_line_for_timestep()</code> (and similar) function</li>
<li>JSON structure should be a list of strings</li>
<li>if not present, defaults to whatever it returned by the model's BMI <code>get_output_var_names()</code> function <em>the first time</em> it is invoked</li>
<li>if specified, must be at the <b>root</b> level of a formulation object.</li>
<li>if specified for multi-BMI, it should be within the <b>formulation-root</b> config level, i.e. in the <b>root</b> config level for a given <b>formulation</b>.</li>
<li>e.g., <div class="fragment"><div class="line">// Example for CFE, which has 13 output variables</div>
<div class="line">&quot;output_variables&quot;: [&quot;RAIN_RATE&quot;, &quot;Q_OUT&quot;]</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><code>output_header_fields</code><ul>
<li>can specify the header strings to use for the realization's printed output (i.e., the value returned by <code>get_output_header_line()</code>)</li>
<li>JSON structure should be a list of strings</li>
<li>when not present, the literal variable names are used</li>
<li>when present, does not do any checking for ordering/correspondence compared to the output ordering of the variable values, so users must take care that ordering is consistent</li>
<li>if specified, must be at the <b>root</b> level of a formulation object.</li>
<li>if specified for multi-BMI, it should be within the <b>formulation-root</b> config level, i.e. in the <b>root</b> config level for a given <b>formulation</b>.</li>
<li>e.g., <div class="fragment"><div class="line">// Same as `output_variables` example with CFE, but we want to change the formatting</div>
<div class="line">&quot;output_header_fields&quot;: [&quot;rain_rate&quot;, &quot;Q&quot;]</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><code>allow_exceed_end_time</code><ul>
<li>boolean value to specify whether a model is allowed to execute <code>Update</code> calls that go beyond its end time (or the max forcing data entry)</li>
<li>implied to be <code>false</code> by default</li>
</ul>
</li>
<li><code>fixed_time_step</code><ul>
<li>boolean value to indicate whether this model has a fixed time step size</li>
<li>implied to be <code>true</code> by default</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md35"></a>
BMI Models Written in C</h1>
<ul>
<li>Model As Shared Library</li>
<li>Example</li>
<li>Caveats</li>
</ul>
<h2><a class="anchor" id="autotoc_md36"></a>
BMI C Model As Shared Library</h2>
<p>For <b>C</b> models, the model must be packaged as a pre-compiled shared library. A CMake cache variables can be configured for controlling whether the framework functionality for working with BMI C libraries is activated. This is found in, or must be added to, the <em>CMakeCache.txt</em> file in the build system directory:</p>
<ul>
<li><code>NGEN_WITH_BMI_C</code><ul>
<li>type: <code>BOOL</code></li>
<li>must be set to <code>ON</code> (or equivalent in CMake) for BMI C shared library functionality to be compiled and active</li>
</ul>
</li>
</ul>
<p>The CMake build system may need to be <a href="BUILDS_AND_CMAKE.md#regenerating">regenerated</a> after changing these settings.</p>
<p>See the CMake documentation on the <em><a href="https://cmake.org/cmake/help/latest/command/set.html">set</a></em> function or <a href="https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#cmake-language-variables">variables</a> for more information on working with CMake variables.</p>
<p>When CMake is able to find the library for the given name, it will automatically set up <a href="../src/realizations/catchment/CMakeLists.txt">the dependent, internal, static library</a> to dynamically link to the external shared library at runtime.</p>
<h3><a class="anchor" id="autotoc_md37"></a>
Dynamic Loading</h3>
<p>Additionally, as noted above, the path to the shared library must be provided in the configuration. This is because C libraries must be loaded dynamically within the execution of the NextGen framework, or else certain limitations of C would prevent using more than one such external C BMI model library at a time.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
BMI C CFE Example</h2>
<p>An example implementation for an appropriate BMI model as a <b>C</b> shared library is provided in the project <a href="../extern/cfe">here</a>.</p>
<h2><a class="anchor" id="autotoc_md39"></a>
BMI C Caveats</h2>
<ul>
<li>Activation/Deactivation in CMake Required</li>
<li>Additional Bootstrapping Function Needed</li>
</ul>
<h3><a class="anchor" id="autotoc_md40"></a>
BMI C Activate/Deactivation Required in CMake Build</h3>
<p>BMI C functionality will not work (i.e., will not be compiled or executable) unless set to be active in the CMake build. This requires setting the <code>NGEN_WITH_BMI_C</code> CMake cache variable to <code>ON</code>.</p>
<p>Conversely, built executables (and perhaps certain build targets) may not function as expected if <code>NGEN_WITH_BMI_C</code> is <code>ON</code> but the configured shared library is not available.</p>
<h3><a class="anchor" id="autotoc_md41"></a>
Additional Bootstrapping Function Needed</h3>
<p>BMI models written in <b>C</b> should implement an extra "registration" function in order to be compatible with NextGen. By default, this registration function is expected to be: </p><pre class="fragment">Bmi* register_bmi(Bmi *model);
</pre><p> It is possible to configure a different name for the function within the NGen realization config, but the return type and parameter list must be as noted here.</p>
<p>The implemented function must set the member pointers of the passed <code><a class="el" href="struct_bmi.html">Bmi</a></code> struct to the appropriate analogous functions inside the model. E.g., the <code>initialize</code> member of the struct: </p><pre class="fragment">int (*initialize)(struct Bmi *self, const char *bmi_init_config)
</pre><p> needs to be set to the module's function the performs the BMI initialization. This will probably be something like: </p><pre class="fragment">static int Initialize (Bmi *self, const char *file)
</pre><p> So the registration function may look something like: </p><pre class="fragment">Bmi* register_bmi_cfe(Bmi *model) {
    if (model) {
        ...
        model-&gt;initialize = Initialize;
        ...
</pre><p> Full examples for how to write this registration function can be found in the local CFE BMI implementation, specifically in <a href="../extern/cfe/src/bmi_cfe.c">extern/cfe/src/bmi_cfe.c</a>, or in the official CSDMS <em>bmi-example-c</em> repo near the bottom of the <a href="https://github.com/csdms/bmi-example-c/blob/master/heat/bmi_heat.c">bmi-heat.c</a> file.</p>
<h4><a class="anchor" id="autotoc_md42"></a>
Why?</h4>
<p>This is needed both due to the design of the <b>C</b> language variant of BMI, and the limitations of C regarding duplication of function names. The latter becomes significant when more than one BMI C library is used at once. Even if that is actively the case, NextGen is designed to accomodate that case, so this requirement is in place.</p>
<p>Future versions of NextGen will provide alternative ways to declaratively configure function names from a BMI C library so they can individually be dynamically loaded.</p>
<h1><a class="anchor" id="autotoc_md43"></a>
BMI Models Written in C++</h1>
<ul>
<li>BMI C++ Model As Shared Library<ul>
<li>Dynamic Loading</li>
<li>Additional Bootstrapping Functions Needed<ul>
<li>Why?</li>
</ul>
</li>
</ul>
</li>
<li>BMI C++ Example</li>
</ul>
<p>You can implement a model in C++ by writing an object which implements the <a href="https://github.com/csdms/bmi-cxx">BMI C++ interface</a>.</p>
<h2><a class="anchor" id="autotoc_md44"></a>
BMI C++ Model As Shared Library</h2>
<p>For <b>C++</b> models, the model should be packaged as a pre-compiled shared library. Support for loading of C++ modules/libraries is always enabled, so no build system flags are required. </p>
<h3><a class="anchor" id="autotoc_md45"></a>
Dynamic Loading</h3>
<p>As noted above, the path to the shared library must be provided in the configuration so that the module can be loaded at runtime.</p>
<h3><a class="anchor" id="autotoc_md46"></a>
Additional Bootstrapping Functions Needed</h3>
<p>BMI models written in <b>C++</b> should implement two <b>C</b> functions declared with <code>extern "C"</code>. These functions instantiate and destroy a <b>C++</b> BMI model object. By default, these functions are expected to be named <code>bmi_model_create</code> and <code>bmi_model_destroy</code>, and have signatures like the following:</p>
<div class="fragment"><div class="line">++</div>
<div class="line">   <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span></div>
<div class="line">   {</div>
<div class="line">     MyBmiModelClass *bmi_model_create()</div>
<div class="line">     {</div>
<div class="line">       <span class="comment">/* You can do anything necessary to set up a model instance here, but do NOT call `Initialize()`. */</span></div>
<div class="line">       <span class="keywordflow">return</span> <span class="keyword">new</span> MyBmiModelClass(<span class="comment">/* e.g. any applicable constructor parameters */</span>);</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="keywordtype">void</span> bmi_model_destroy(MyBmiModelClass *ptr)</div>
<div class="line">     {</div>
<div class="line">       <span class="comment">/* You can do anything necessary to dispose of a model instance here, but note that `Finalize()` </span></div>
<div class="line"><span class="comment">        * will already have been called!</span></div>
<div class="line"><span class="comment">       delete ptr;</span></div>
<div class="line"><span class="comment">     }</span></div>
<div class="line"><span class="comment">   }</span></div>
</div><!-- fragment --><p>It is possible to configure different <em>names</em> for the functions within the NGen realization config by using the keys <code>create_function</code> and <code>destroy_function</code>, but the return types and parameters must be as shown above.</p>
<p>An example of implementing these functions can be found in the test harness implementation at <a href="../extern/test_bmi_cpp/include/test_bmi_cpp.hpp">/extern/test_bmi_cpp/include/test_bmi_cpp.hpp</a>. </p>
<h4><a class="anchor" id="autotoc_md47"></a>
Why?</h4>
<p>Counterintuitively, loading C++ shared libraries into a C++ executable (such as the NextGen framework) requires the use of standard C functions. This is because all C++ compilers "mangle" the names of C++ functions and classes in order to support polymorphism and other scenarios where C++ symbols are allowed to have the same name (which is not possible in standard C). This "mangling" algorithm is not specified or defined so different compilers may use different methods&ndash;and even different versions of the same compiler can vary&ndash;such that it is not possible to predict the symbol name for any C++ class or function in a compiled shared library. Only by using <code>extern "C"</code> will the compiler produce a library with a predictable symbol name (and no two functions having the <code>extern "C"</code> declaration may have the same name!), so this mechanism is used whenever dynamic loading of C++ library classes is needed.</p>
<p>Similarly, different compilers (or different compiler versions) may implement <code>delete</code> differently, or layout private memory of an object differently. This is why the <code>bmi_model_destroy</code> function should be implemented in the library where the object was instantiated: to prevent compiler behavior differences from potentially freeing memory incorrectly.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
BMI C++ Example</h2>
<p>An example implementation for an appropriate BMI model as a <b>C++</b> shared library is provided in the project <a href="../extern/test_bmi_cpp">here</a>.</p>
<h1><a class="anchor" id="autotoc_md49"></a>
BMI Models Written in Python</h1>
<ul>
<li>Enabling Python Integration</li>
<li>BMI Python Model as Package Class</li>
<li>BMI Python Example</li>
</ul>
<h2><a class="anchor" id="autotoc_md50"></a>
Enabling Python Integration</h2>
<p>Python integration is controlled with the CMake build flag <code>NGEN_WITH_PYTHON</code>, however this currently defaults to "On"&ndash;you would need to turn this off if Python is not available in your environment. See <a href="DEPENDENCIES.md#python-3-libraries">the Dependencies documentation</a> for specifics on Python requirements, but in summary you will need a working Python environment with NumPy installed. You can set up a Python environment anywhere with the usual environment variables. The appropriate Python environment should be active in the shell when ngen is run.</p>
<p>For Python BMI models specifically, you will also need to install the <a href="https://github.com/csdms/bmi-python">bmipy</a> package, which provides a base class for Python BMI models.</p>
<h2><a class="anchor" id="autotoc_md51"></a>
BMI Python Model as Package Class</h2>
<p>To use a Python BMI model, the model needs to be installed as a package in the Python environment and the package must have a class that extends bmipy, like so</p>
<div class="fragment"><div class="line"><span class="keyword">from</span> bmipy <span class="keyword">import</span> Bmi</div>
<div class="line"><span class="keyword">class </span>bmi_model(<a class="code hl_struct" href="struct_bmi.html">Bmi</a>):</div>
<div class="line">    ...</div>
<div class="ttc" id="astruct_bmi_html"><div class="ttname"><a href="struct_bmi.html">Bmi</a></div><div class="ttdef"><b>Definition</b> bmi.h:53</div></div>
</div><!-- fragment --><p><b>TIP:</b> If you are actively developing a Python BMI model, you may want to <a href="https://pip.pypa.io/en/stable/topics/local-project-installs/#editable-installs">install your package with the <code>-e</code> flag</a>.</p>
<p>As noted above, Python modules require the package and class name to be specified in the realization config via the <code>python_class</code> key, such as:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;global&quot;: {</div>
<div class="line">    &quot;formulations&quot;: [</div>
<div class="line">        { </div>
<div class="line">            &quot;name&quot;: &quot;bmi_python&quot;,</div>
<div class="line">            &quot;params&quot;: {</div>
<div class="line">                &quot;python_type&quot;: &quot;mypackage.bmi_model&quot;,</div>
<div class="line">                &quot;model_type_name&quot;: &quot;bmi_model&quot;,</div>
<div class="line">                //...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md52"></a>
BMI Python Example</h2>
<p>An example implementation for an appropriate BMI model as a <b>Python</b> class is <a href="../extern/test_bmi_py">provided in the project</a>, or you can examine the CSDMS-provided <a href="https://github.com/csdms/bmi-example-python">example Python model</a>.</p>
<h1><a class="anchor" id="autotoc_md53"></a>
BMI Models Written in Fortran</h1>
<ul>
<li>Enabling Fortran Integration</li>
<li>ISO_C_BINDING Middleware</li>
<li>A Compiled Shared Library<ul>
<li>Required Additional Fortran Registration Function</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md54"></a>
Enabling Fortran Integration</h2>
<p>To enable Fortran integration functionality, the CMake build system has to be <a href="BUILDS_AND_CMAKE.md#generating-a-build-system">generated</a> with the <code>NGEN_WITH_BMI_FORTRAN</code> CMake variable set to <code>ON</code>.</p>
<h2><a class="anchor" id="autotoc_md55"></a>
ISO C Binding Middleware</h2>
<p>Nextgen takes advantage of the Fortran <code>iso_c_binding</code> module to achieve interoperability with Fortran modules. In short, this works through use of an intermediate middleware module maintained within Nextgen. This module handles the (majority of the) binding through proxy functions that make use of the actual external BMI Fortran module. <br  />
</p>
<p>The middleware module source is located in <em>extern/iso_c_fortran_bmi/</em>.</p>
<p>The proxy functions require an opaque handle to a created BMI Fortran object to be provided as an argument, so such an object and its opaque handle must be setup and returned via a `register_bmi` function.</p>
<h2><a class="anchor" id="autotoc_md56"></a>
A Compiled Shared Library</h2>
<p>Because of the use of <code>iso_c_bindings</code>, integrating with a Fortran BMI module works very similarly to integrating with a C BMI module, where a shared library is dynamically loaded. An extra bootstrapping registration function is also, again, required.</p>
<h3><a class="anchor" id="autotoc_md57"></a>
Required Additional Fortran Registration Function</h3>
<p>As with C, a registration function must be provided by the module, beyond what is implemented for BMI. It should look very similar to the example below. In fact, it is likely sufficient to simply modify the <code>use bminoahowp</code> and <code>type(bmi_noahowp), target, save :: bmi_model</code> lines to suit the module in question.</p>
<p>This function should receive an opaque pointer and set it to point to a created BMI object of the appropriate type for the module. Note that while <code>save</code> is being used in a way that persists only the initial object, since this will be used within the scope of a dynamic library loaded specifically for working with a particular catchment formulation, it should not cause issues.</p>
<div class="fragment"><div class="line"><span class="keyword">function </span>register_bmi(this) <span class="keyword">result</span>(bmi_status) <span class="keyword">bind(C, name=&quot;register_bmi&quot;)</span></div>
<div class="line">      use, <span class="keywordtype">intrinsic</span>:: iso_c_binding, only: c_ptr, c_loc, c_int</div>
<div class="line">      <span class="keywordtype">use </span>bminoahowp</div>
<div class="line">      <span class="keywordtype">implicit none</span></div>
<div class="line">      <span class="keywordtype">type</span>(c_ptr) :: this <span class="comment">! If not value, then from the C perspective `this` is a void**</span></div>
<div class="line">      <span class="keywordtype">integer(kind=c_int)</span> :: bmi_status</div>
<div class="line">      <span class="comment">!Create the momdel instance to use</span></div>
<div class="line">      <span class="keywordtype">type</span>(bmi_noahowp), <span class="keywordtype">target</span>, <span class="keywordtype">save</span> :: bmi_model <span class="comment">!should be safe, since this will only be used once within scope of dynamically loaded library</span></div>
<div class="line">      <span class="comment">!Create a simple pointer wrapper</span></div>
<div class="line">      <span class="keywordtype">type</span>(box), <span class="keywordtype">pointer</span> :: bmi_box</div>
<div class="line"> </div>
<div class="line">      <span class="comment">!allocate the pointer box</span></div>
<div class="line">      <span class="keyword">allocate</span>(bmi_box)</div>
<div class="line">      <span class="comment">!allocate(bmi_box%ptr, source=bmi_model)</span></div>
<div class="line">      bmi_box%foobar = 42 </div>
<div class="line">      <span class="comment">!associate the wrapper pointer the created model instance</span></div>
<div class="line">      bmi_box%ptr =&gt; bmi_model</div>
<div class="line">      <span class="comment">!Return the pointer to box</span></div>
<div class="line">      this = c_loc(bmi_box)</div>
<div class="line">      bmi_status = bmi_success</div>
<div class="line">    <span class="keyword">end function </span>register_bmi</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md58"></a>
Multi-Module BMI Formulations</h1>
<p>It is possible to configure a formulation to be a combination of several different individual BMI module components. This is the <code>bmi_multi</code> formulation type. At each time step, formulations of this type proceed through each nested module <em>in configured order</em> and call either the BMI <code>update()</code> or <code>update_until()</code> function for each.</p>
<details >
<summary >
Click here for <code>bmi_multi</code> example</summary>
<p></p>
<div class="fragment"><div class="line">&quot;formulations&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;name&quot;: &quot;bmi_multi&quot;,</div>
<div class="line">        &quot;params&quot;: {</div>
<div class="line">            &quot;model_type_name&quot;: &quot;bmi_multi_pet_cfe&quot;,</div>
<div class="line">            &quot;forcing_file&quot;: &quot;&quot;,</div>
<div class="line">            &quot;init_config&quot;: &quot;&quot;,</div>
<div class="line">            &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">            &quot;main_output_variable&quot;: &quot;Q_OUT&quot;,</div>
<div class="line">            &quot;modules&quot;: [</div>
<div class="line">                {</div>
<div class="line">                    &quot;name&quot;: &quot;bmi_c&quot;,</div>
<div class="line">                    &quot;params&quot;: {</div>
<div class="line">                        &quot;model_type_name&quot;: &quot;PET&quot;,</div>
<div class="line">                        &quot;library_file&quot;: &quot;bmi_module_libs/libpetbmi.so&quot;,</div>
<div class="line">                        &quot;forcing_file&quot;: &quot;&quot;,</div>
<div class="line">                        &quot;init_config&quot;: &quot;config_dir/cat-10_pet_config.txt&quot;,</div>
<div class="line">                        &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">                        &quot;main_output_variable&quot;: &quot;water_potential_evaporation_flux&quot;,</div>
<div class="line">                        &quot;registration_function&quot;:&quot;register_bmi_pet&quot;,</div>
<div class="line">                        &quot;variables_names_map&quot;: {</div>
<div class="line">                            &quot;water_potential_evaporation_flux&quot;: &quot;EVAPOTRANS&quot;</div>
<div class="line">                        },</div>
<div class="line">                        &quot;uses_forcing_file&quot;: false</div>
<div class="line">                    }</div>
<div class="line">                },</div>
<div class="line">                {</div>
<div class="line">                    &quot;name&quot;: &quot;bmi_c&quot;,</div>
<div class="line">                    &quot;params&quot;: {</div>
<div class="line">                        &quot;model_type_name&quot;: &quot;CFE&quot;,</div>
<div class="line">                        &quot;library_file&quot;: &quot;bmi_module_libs/libcfebmi.so&quot;,</div>
<div class="line">                        &quot;forcing_file&quot;: &quot;&quot;, </div>
<div class="line">                        &quot;init_config&quot;: &quot;config_dir/cat-10_bmi_config_cfe_pass.txt&quot;,</div>
<div class="line">                        &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">                        &quot;main_output_variable&quot;: &quot;Q_OUT&quot;,</div>
<div class="line">                        &quot;registration_function&quot;: &quot;register_bmi_cfe&quot;,</div>
<div class="line">                        &quot;variables_names_map&quot;: {</div>
<div class="line">                            &quot;atmosphere_water__liquid_equivalent_precipitation_rate&quot;: &quot;RAINRATE&quot;,</div>
<div class="line">                            &quot;water_potential_evaporation_flux&quot;: &quot;EVAPOTRANS&quot;,</div>
<div class="line">                            &quot;ice_fraction_schaake&quot;: &quot;sloth_ice_fraction_schaake&quot;,</div>
<div class="line">                            &quot;ice_fraction_xinan&quot;: &quot;sloth_ice_fraction_xinan&quot;,</div>
<div class="line">                            &quot;soil_moisture_profile&quot;: &quot;sloth_smp&quot;</div>
<div class="line">                        },  </div>
<div class="line">                        &quot;uses_forcing_file&quot;: false</div>
<div class="line">                    }   </div>
<div class="line">                }, </div>
<div class="line">                    {</div>
<div class="line">                        &quot;name&quot;: &quot;bmi_c++&quot;,</div>
<div class="line">                        &quot;params&quot;: {</div>
<div class="line">                            &quot;name&quot;: &quot;bmi_c++&quot;,</div>
<div class="line">                            &quot;model_type_name&quot;: &quot;SLOTH&quot;,</div>
<div class="line">                            &quot;main_output_variable&quot;: &quot;z&quot;,</div>
<div class="line">                            &quot;library_file&quot;: &quot;bmi_module_libs/libslothmodel.so&quot;,</div>
<div class="line">                            &quot;init_config&quot;: &quot;/dev/null&quot;,</div>
<div class="line">                            &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">                            &quot;fixed_time_step&quot;: false,</div>
<div class="line">                            &quot;uses_forcing_file&quot;: false,</div>
<div class="line">                            &quot;model_params&quot;: {</div>
<div class="line">                            &quot;sloth_ice_fraction_schaake(1,double,m,node)&quot;: 0.0,</div>
<div class="line">                            &quot;sloth_ice_fraction_xinan(1,double,1,node)&quot;: 0.0,</div>
<div class="line">                            &quot;sloth_smp(1,double,1,node)&quot;: 0.0</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            ],</div>
</div><!-- fragment --> </details>
<p>As described in Required Parameters, a BMI <code>init_config</code> does not need to be specified for this formulation type, but a nested list of sub-formulation configs (in <code>modules</code>) does. Execution of a formulation time step update proceeds through each module in list order.</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Passing Variables Between Nested Formulations</h2>
<p>In addition to using framework-supplied forcings as module inputs, a <code>bmi_multi</code> formulation orchestrate the output variable values of one nested module for use as the input variable values of another. This imposes some extra conditions and requirements on the configuration.</p>
<h3><a class="anchor" id="autotoc_md60"></a>
How Values Are Orchestrated</h3>
<p>The <code>bmi_multi</code> formulation orchestrates values by pairing all nested module input variables with some nested module or framework-provided output variable. Paring is done by examining the identifiers for the variables - either a variable's alias configured via <code>variables_names_map</code> (see here) or, if the former wasn't provided, its name - and providing each input with values from an output with a matching identifier. <br  />
</p>
<p>E.g., if <em>module_1</em> has an output variable with either a name or configured alias of <em>et</em>, and <em>module_2</em> has an input variable with a name or an alias of <em>et</em>, then the formulation will know to use <em>module_1.et</em> at each time step to set <em>module_2.et</em>.</p>
<p>This imposes several constraints on the configuration:</p>
<ul>
<li>each nested module output variable identifier must be unique among available outputs in the formulation<ul>
<li>i.e., there cannot be two nested modules that have an output variable with the same identifier</li>
<li>a variable's name is its default identifier</li>
<li>if two nest modules both have an output variable with the same name, a mapped alias must be configured for at least one of them via <code>variables_names_map</code> (see here)</li>
<li>an alias is also needed if an output name matches a framework-provided forcing value</li>
</ul>
</li>
<li>each input variable identifier must match some output identifier<ul>
<li>inputs do not require configured aliases, though it is possible to configure an alias to match with the appropriate output identifier (especially for framework-provided forcings)</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md61"></a>
Look-back and Default Values</h3>
<p>Any nested module, regardless of its position in the configured order of the modules, may have its provided outputs used as the input values for any other nested module in that formulation. Because modules are updated in order, configuring an earlier module - e.g., <em>module_1</em> - to receive an input value from an output variable of a later module - e.g., <em>module_2</em> - induces a "look-back" capability. At the time <em>module_1</em> needs its input for the current time step, <em>module_2</em> will have not yet processed the current time step. As such, <em>module_2</em>'s output variable values will be those from the previous time step.</p>
<p>This introduces a special case for when there is no previous time step. Not every BMI module used in this kind of "look-back" scenario will be able to provide a valid output value before processing the first time step. To account for this, an optional default value can be configured for output variables, associated via the identifier (i.e., mapped alias or variable name). <br  />
</p>
<blockquote class="doxtable">
<p>&zwj;[!NOTE] Currently only <code>double</code> default values are supported. </p>
</blockquote>
<h4><a class="anchor" id="autotoc_md62"></a>
Example Look-Back Config</h4>
<p>Below is a partial config example illustrating a look-back setup involving CFE and SoilMoistureProfile (SMP). CFE relies upon the soil moisture profile value from SMP (mapped in both as <code>soil_moisture_profile__smp_output__cfe_input</code>) that was calculated in the previous time step. Because SMP wasn't implemented to have its own default values for variables, a default value is supplied in the configuration that CFE will use in the first time step.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;global&quot;: {</div>
<div class="line">    &quot;formulations&quot;: [</div>
<div class="line">      {</div>
<div class="line">        &quot;name&quot;: &quot;bmi_multi&quot;,</div>
<div class="line">        &quot;params&quot;: {</div>
<div class="line">          &quot;model_type_name&quot;: &quot;bmi_multi_noahmp_cfe&quot;,</div>
<div class="line">          &quot;forcing_file&quot;: &quot;&quot;,</div>
<div class="line">          &quot;init_config&quot;: &quot;&quot;,</div>
<div class="line">          &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">          &quot;main_output_variable&quot;: &quot;Q_OUT&quot;,</div>
<div class="line">          &quot;default_output_values&quot;: [</div>
<div class="line">            {</div>
<div class="line">              &quot;name&quot;: &quot;soil_moisture_profile__smp_output__cfe_input&quot;,</div>
<div class="line">              &quot;value&quot;: 1.2345</div>
<div class="line">            }</div>
<div class="line">          ],</div>
<div class="line">          &quot;modules&quot;: [</div>
<div class="line">            {</div>
<div class="line">              &quot;name&quot;: &quot;bmi_c&quot;,</div>
<div class="line">              &quot;params&quot;: {</div>
<div class="line">                &quot;model_type_name&quot;: &quot;bmi_c_cfe&quot;,</div>
<div class="line">                &quot;library_file&quot;: &quot;./ngen/extern/cfe/cmake_build/libcfebmi&quot;,</div>
<div class="line">                &quot;forcing_file&quot;: &quot;&quot;,</div>
<div class="line">                &quot;init_config&quot;: &quot;./configs/cfe/cat-20521.txt&quot;,</div>
<div class="line">                &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">                &quot;main_output_variable&quot;: &quot;Q_OUT&quot;,</div>
<div class="line">                &quot;registration_function&quot;: &quot;register_bmi_cfe&quot;,</div>
<div class="line">                &quot;variables_names_map&quot;: {</div>
<div class="line">                  &quot;soil_moisture_profile&quot;: &quot;soil_moisture_profile__smp_output__cfe_input&quot;</div>
<div class="line">                  &quot;SOIL_STORAGE&quot;: &quot;soil_storage__cfe_output__smp_input&quot;,</div>
<div class="line">                  &quot;SOIL_STORAGE_CHANGE&quot;: &quot;soil_storage__cfe_output__smp_input&quot;,</div>
<div class="line">                },</div>
<div class="line">                &quot;uses_forcing_file&quot;: false</div>
<div class="line">              }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">              &quot;name&quot;: &quot;bmi_c++&quot;,</div>
<div class="line">              &quot;params&quot;: {</div>
<div class="line">                &quot;model_type_name&quot;: &quot;bmi_smp&quot;,</div>
<div class="line">                &quot;library_file&quot;: &quot;./ngen/extern/SoilMoistureProfiles/cmake_build/libsmpbmi&quot;,</div>
<div class="line">                &quot;init_config&quot;: &quot;./configs/smp_cfe/cat-20521.txt&quot;,</div>
<div class="line">                &quot;allow_exceed_end_time&quot;: true,</div>
<div class="line">                &quot;main_output_variable&quot;: &quot;soil_water_table&quot;,</div>
<div class="line">                &quot;variables_names_map&quot; : {</div>
<div class="line">                  &quot;soil_storage&quot; : &quot;soil_storage__cfe_output__smp_input&quot;,</div>
<div class="line">                  &quot;soil_storage_change&quot; : &quot;soil_storage__cfe_output__smp_input&quot;,</div>
<div class="line">                  &quot;soil_moisture_profile&quot;: &quot;soil_moisture_profile__smp_output__cfe_input&quot;</div>
<div class="line">                },</div>
<div class="line">                &quot;uses_forcing_file&quot;: false</div>
<div class="line">              }</div>
<div class="line">            }</div>
<div class="line">          ]</div>
<div class="line">...</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;[!IMPORTANT] As mentioned, even for such look-back scenarios, default output values are not strictly required.</p>
<p>The BMI specification does not restrict when values for a variable may be available, except to say that the <code>initialize()</code> function may need to be called first. In other words, some modules may be able to provide their own appropriate default variable values, before the first time step update.</p>
<p>To provide general support, <code>bmi_multi</code> formulation must allow for this scenario, although users should be very careful to not accidentally omit configuring default values for a module that does not supply them on its own. </p>
</blockquote>
<blockquote class="doxtable">
<p>&zwj;[!WARNING] <br  />
 Users should not assume that the error-free execution of a configuration with nested module look-back and without default values implies that the module was designed to provided <em>correct</em> default values. </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jun 3 2024 05:55:41 for NGen by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
