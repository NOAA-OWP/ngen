# This configuration file is for the high-resolution, multiscale, differentiable hydrologic model, dHBV2.0UH, from Song et al. (2025). If you find this code is useful to your work, please cite the paper below:
# Yalan Song, Tadd Bindas, Chaopeng Shen, et al. "High-resolution national-scale water modeling is enhanced by multiscale differentiable physics-informed machine learning." Water Resources Research (2025). https://doi.org/10.1029/2024WR038928.

## General -------------------------------#
mode: sim  # train, test, train_test, sim
do_tune: false  # python -m dmg +tune=true

multimodel_type: none  # none, nn_parallel, nn_sequential
seed: 42
cache_states: true
device: cpu
gpu_id: 0


data_loader: MtsHydroLoader
data_sampler: MtsHydroSampler
trainer: MtsTrainer

save_path: .
model_dir: models/hfv2.2_15yr/  # The trained dHBV 2.0 model (+ input data) can be downloaded from: https://mhpi-spatial.s3.us-east-2.amazonaws.com/mhpi-release/models/dHBV_2_MTS_trained.zip


## Training ------------------------------#
train:
  # NOTE: Training code for dHBV2.0 MTS will be enabled in dMG at a later time.
  start_time: 1991/01/01
  end_time: 2003/12/31
  target: [streamflow]
  optimizer:
    name: Adam
  lr: 0.001
  lr_scheduler:
    name: none
  loss_function:
    name: WeightedNSELossBatch
    alpha: 0.0
    gamma: 1.0
    max_w: 1.0

  batch_size: 100
  epochs: 30
  start_epoch: 0
  save_epoch: 1
  stride: 168
  chunk_year_size: 1

## Validation -------------------------------#
valid:
  start_time: 2004/01/01
  end_time: 2008/12/31
  batch_size: 200


## Evaluation -------------------------------#
test:
  start_time: 2009/01/01
  end_time: 2018/12/31
  batch_size: 200
  test_epoch: 24


## Inference -------------------------------#
sim:
  start_time: 2009/01/01
  end_time: 2018/12/31
  batch_size: 200


## Differentiable Model -----------------------------#
model:
  rho: 365
  warm_up: 0
  use_log_norm: []

  phy:
    ## Citations ##
    # HBV2.0 MTS: Yalan Song, Tadd Bindas, Chaopeng Shen, et al. High-resolution national-scale water modeling is enhanced by multiscale differentiable physics-informed machine learning. ESS Open Archive. September 26, 2024. https://doi.org/10.22541/essoar.172736277.74497104/v1.

    name: ['Hbv_2_mts']

    hif_model:
      name: [Hbv_2_hourly]
      nmul: 1
      warm_up_states: true
      dy_drop: 0.0
      dynamic_params:
        Hbv_2_hourly: [parBETA, parK0, parBETAET]

      routing: false
      nearzero: 1e-5

      window_size: 336  # (hours)
      train_warmup: 168  # for training loss, also for routing
      agg_timescale_dim: [0, 2]  # indexes of P and PET in forcings, sum aggregation from high to low freq
      train_spatial_chunk_size: 65536  # number of unit-basins per sub-batch for high-freq model training
      simulate_spatial_chunk_size: 10000  # number of unit-basins per sub-batch for runoff generation during simulation
      simulate_temporal_chunk_size: 168  # number of time steps per sub-batch for runoff routing during simulation

      forcings: [
        P,
        T,
        PET,
      ]
      attributes: []

    lof_model:
      name: [Hbv_2]
      nmul: 1
      warm_up_states: true
      dy_drop: 0.0
      dynamic_params:
        Hbv_2: [parBETA, parK0, parBETAET]

      routing: false
      nearzero: 1e-5

      window_size: 351

      forcings: [
        P,
        T,
        PET,
      ]
      attributes: []

  nn:
    sub_batch_size: 100  # avoid cuda OOM for distributed model

    hif_model:
      name: LstmMlp2Model

      lstm_dropout: 0.1
      lstm_hidden_size: 32

      mlp_dropout: 0.1
      mlp_hidden_size: 64

      mlp2_dropout: 0.1
      mlp2_hidden_size: 64

      forcings: [
        P,
        T,
        PET,
      ]
      attributes: [
        aridity,
        meanP,
        ETPOT_Hargr,
        NDVI,
        FW,
        meanslope,
        SoilGrids1km_sand,
        SoilGrids1km_clay,
        SoilGrids1km_silt,
        glaciers,
        HWSD_clay,
        HWSD_gravel,
        HWSD_sand,
        HWSD_silt,
        meanelevation,
        meanTa,
        permafrost,
        permeability,
        seasonality_P,
        seasonality_PET,
        snow_fraction,
        snowfall_fraction,
        T_clay,
        T_gravel,
        T_sand,
        T_silt,
        Porosity,
        catchsize,
      ]
      attributes2: [
        aridity,
        NDVI,
        FW,
        meanslope,
        SoilGrids1km_sand,
        SoilGrids1km_clay,
        SoilGrids1km_silt,
        glaciers,
        HWSD_clay,
        HWSD_gravel,
        HWSD_sand,
        HWSD_silt,
        meanelevation,
        permafrost,
        permeability,
        snow_fraction,
        T_clay,
        T_gravel,
        T_sand,
        T_silt,
        Porosity,
        catchsize,
        lengthkm,
      ]

    lof_model:
      model: LstmMlpModel

      lstm_dropout: 0.1
      lstm_hidden_size: 32

      mlp_dropout: 0.1
      mlp_hidden_size: 64

      forcings: [
        P,
        T,
        PET,
      ]
      attributes: [
        aridity,
        meanP,
        ETPOT_Hargr,
        NDVI,
        FW,
        meanslope,
        SoilGrids1km_sand,
        SoilGrids1km_clay,
        SoilGrids1km_silt,
        glaciers,
        HWSD_clay,
        HWSD_gravel,
        HWSD_sand,
        HWSD_silt,
        meanelevation,
        meanTa,
        permafrost,
        permeability,
        seasonality_P,
        seasonality_PET,
        snow_fraction,
        snowfall_fraction,
        T_clay,
        T_gravel,
        T_sand,
        T_silt,
        Porosity,
        catchsize,
      ]

# NOTE: needed until either config init is ported from dMG, or this is
# dynamically added by the BMI. (Necessary settings from data.yaml)
observations:
  name: hfv2.2_forward
  start_time: 1980/01/01
  end_time: 2020/12/31
  runoff_start_time: '1979-01-01 13:00:00'

  subbasin_id_name: divide_id
  upstream_area_name: uparea
  subbasin_area_name: catchsize
  elevation_name: meanelevation
