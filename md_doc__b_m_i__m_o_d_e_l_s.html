<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NGen: BMI External Models</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NGen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_doc__b_m_i__m_o_d_e_l_s.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">BMI External Models </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#formulation-config">Formulation Config</a><ul>
<li><a href="#required-parameters">Required Parameters</a></li>
<li><a href="#semi-optional-parameters">Semi-Optional Parameters</a></li>
<li><a href="#optional-parameters">Optional Parameters</a></li>
</ul>
</li>
<li><a href="#bmi-models-written-in-c">BMI Models Written in C</a><ul>
<li><a href="#bmi-c-shared-library">BMI C Model As Shared Library</a></li>
<li><a href="#bmi-c-cfe-example">Example: CFE Shared Library</a></li>
<li><a href="#bmi-c-caveats">BMI C Caveats</a></li>
</ul>
</li>
<li><a href="#multi-module-bmi-formulations">Multi-Module BMI Formulations</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md21"></a>
Summary</h1>
<p>The basic outline of steps needed to work with an external BMI model is:</p><ul>
<li>Configure the main formulation/realization config properly for the catchments that will use the generalized BMI realization(s)</li>
<li>Make sure all the necessary model-specific BMI initialization files are valid and in place</li>
<li>Take appropriate steps to make model source files accessible as needed (e.g., making sure shared library files are in a known location)</li>
<li>Be aware of any model-language-specific caveats<ul>
<li><a href="#bmi-c-caveats">Caveats for C language models</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md22"></a>
Formulation Config</h1>
<p>The catchment entry in the formulation/realization config must be set to used the appropriate type for the associated BMI realization, via the formulation's <code>name</code> JSON element. E.g.: </p><pre class="fragment">  ...
  "cat-87": {
       "formulations": [
           {
               "name": "bmi_c",
               "params": { ... }
           }
       }
  ...
</pre><p> Valid name values for the currently implemented BMI formulation types are:</p>
<ul>
<li><code>bmi_c</code></li>
</ul>
<p>Because of the generalization of the interface to the model, the required and optional parameters for all the BMI formulation types are the same.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Required Parameters</h2>
<p>Certain parameters are strictly required in the formulation/realization JSON config for a catchment entry using a BMI formulation type. Note that there is a slight distinction in "required" between single-module (e.g., <code>bmi_c</code>) and multi-module formulations (i.e., <code>bmi_multi</code>). These are summarized in the following table, with the details of the parameters list below.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Param   </th><th class="markdownTableHeadNone">Single-Module   </th><th class="markdownTableHeadNone">Multi-Module    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>model_type_name</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone">:heavy_check_mark:    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>init_config</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>uses_forcing_file</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>main_output_variable</code>   </td><td class="markdownTableBodyNone">:heavy_check_mark:   </td><td class="markdownTableBodyNone">:heavy_check_mark:    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>modules</code>   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">:heavy_check_mark:   </td></tr>
</table>
<h4><a class="anchor" id="autotoc_md24"></a>
Parameter Details:</h4>
<ul>
<li><code>model_type_name</code><ul>
<li>string name for the particular backing model type</li>
<li>may not be utilized in all cases, but still required</li>
</ul>
</li>
<li><code>init_config</code><ul>
<li>the string path to the BMI initialization config file for the catchment</li>
</ul>
</li>
<li><code>uses_forcing_file</code><ul>
<li>boolean indicating whether the backing BMI model is written to read input forcing data from a forcing file (as opposed to receiving it via getters calls made by the framework)</li>
</ul>
</li>
<li><code>main_output_variable</code><ul>
<li>the string value of the primary output variable</li>
<li>this is the value that returned by the realization's <code>get_response()</code></li>
<li>the string must match an item return by the relevant variant of the BMI <code>get_output_var_names()</code> function</li>
</ul>
</li>
<li><code>modules</code><ul>
<li>a list of individual formulation configs for component modules of a BMI multi-module formulation</li>
<li>each item in the list will be another nested JSON config object for a BMI formulation</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md25"></a>
Semi-Optional Parameters</h2>
<p>There are some special BMI formulation config parameters which are required in certain circumstances, but which are neither <em>always</em> required nor required for either all single- or multi-module formulations. Thus, they do not behave exactly as <em>Required</em> params do in the configuration. However, they should be thought of as de facto required (and will trigger errors when missing) in the specific situations in which they are applicable.</p>
<ul>
<li><code>forcing_file</code><ul>
<li>string path to the forcing data file for the catchment</li>
<li>must be set whenever a model needs to read its own forcings directly<ul>
<li>this is set/indicated using <code>uses_forcing_file</code> as described above</li>
</ul>
</li>
<li>the BMI model's initialization config (i.e., <code>init_config</code> above) may define an analogous property, and the two should properly correspond in such cases</li>
</ul>
</li>
<li><code>library_file</code><ul>
<li>Path to the library file for the BMI library</li>
<li>Required for C-based BMI model formulations</li>
</ul>
</li>
<li><code>registration_function</code><ul>
<li>Name of the <a href="#additional-bootstrapping-function-needed">bootstrapping pointer registration function</a> in the external module</li>
<li>required for C-based BMI modules if the module's implemented function is not named <code>register_bmi</code> as discussed <a href="#additional-bootstrapping-function-needed">here</a></li>
<li>only needed for C-based BMI modules</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md26"></a>
Optional Parameters</h2>
<ul>
<li><code>variables_names_map</code><ul>
<li>can specify a mapping of model variable names (input or output) to supported standard names</li>
<li>supported standard names are listed in the <a href="..include/realizations/catchment/Bmi_Formulation.hpp">Bmi_Formulation.hpp</a> file</li>
<li>this can be useful in particular for informing the framework how to provide the input a model needs for execution</li>
<li>e.g., <code>"variables_names_map": {"model_variable_name": "standard_variable_name"}</code></li>
</ul>
</li>
<li><code>output_variables</code><ul>
<li>can specify the particular set and order of output variables to include in the realization's <code>get_output_line_for_timestep()</code> (and similar) function</li>
<li>JSON structure should be a list of strings</li>
<li>if not present, defaults to whatever it returned by the model's BMI <code>get_output_var_names()</code> function <em>the first time</em> it is invoked</li>
</ul>
</li>
<li><code>output_header_fields</code><ul>
<li>can specify the header strings to use for the realization's printed output (i.e., the value returned by <code>get_output_header_line()</code>)</li>
<li>JSON structure should be a list of strings</li>
<li>when not present, the literal variable names are used</li>
<li>when present, does not do any checking for ordering/correspondence compared to the output ordering of the variable values, so users must take care that ordering is consistent</li>
</ul>
</li>
<li><code>allow_exceed_end_time</code><ul>
<li>boolean value to specify whether a model is allowed to execute <code>Update</code> calls that go beyond its end time (or the max forcing data entry)</li>
<li>implied to be <code>false</code> by default</li>
</ul>
</li>
<li><code>fixed_time_step</code><ul>
<li>boolean value to indicate whether this model has a fixed time step size</li>
<li>implied to be <code>true</code> by default</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md27"></a>
BMI Models Written in C</h1>
<ul>
<li><a href="#bmi-c-model-as-shared-library">Model As Shared Library</a></li>
<li><a href="#bmi-c-cfe-example">Example</a></li>
<li><a href="#bmi-c-caveats">Caveats</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md28"></a>
BMI C Model As Shared Library</h2>
<p>For <b>C</b> models, the model must be packaged as a pre-compiled shared library. A CMake cache variables can be configured for controlling whether the framework functionality for working with BMI C libraries is activated. This is found in, or must be added to, the <em>CMakeCache.txt</em> file in the build system directory:</p>
<ul>
<li><code>BMI_C_LIB_ACTIVE</code><ul>
<li>type: <code>BOOL</code></li>
<li>must be set to <code>ON</code> (or equivalent in CMake) for BMI C shared library functionality to be compiled and active</li>
</ul>
</li>
</ul>
<p>The CMake build system may need to be <a href="BUILDS_AND_CMAKE.md#regenerating">regenerated</a> after changing these settings.</p>
<p>See the CMake documentation on the <em><a href="https://cmake.org/cmake/help/latest/command/set.html">set</a></em> function or <a href="https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#cmake-language-variables">variables</a> for more information on working with CMake variables.</p>
<p>When CMake is able to find the library for the given name, it will automatically set up <a href="../src/realizations/catchment/CMakeLists.txt">the dependent, internal, static library</a> to dynamically link to the external shared library at runtime.</p>
<h3><a class="anchor" id="autotoc_md29"></a>
Dynamic Loading</h3>
<p>Additionally, as noted <a href="#semi-optional-parameters">above</a>, the path to the shared library must be provided in the configuration. This is because C libraries must be loaded dynamically within the execution of the NextGen framework, or else certain limitations of C would prevent using more than one such external C BMI model library at a time.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
BMI C CFE Example</h2>
<p>An example implementation for an appropriate BMI model as a <b>C</b> shared library is provided in the project <a href="../extern/cfe">here</a>.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
BMI C Caveats</h2>
<ul>
<li><a href="#bmi-c-activatedeactivation-required-in-cmake-build">Activation/Deactivation in CMake Required</a></li>
<li><a href="#additional-bootstrapping-function-needed">Additional Bootstrapping Function Needed</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md32"></a>
BMI C Activate/Deactivation Required in CMake Build</h3>
<p>BMI C functionality will not work (i.e., will not be compiled or executable) unless set to be active in the CMake build. This requires setting the <code>BMI_C_LIB_ACTIVE</code> CMake cache variable to <code>ON</code> or <code>TRUE</code> (or equivalent).</p>
<p>Conversely, built executables (and perhaps certain build targets) may not function as expected if <code>BMI_C_LIB_ACTIVE</code> is <code>ON</code> but the configured shared library is not available.</p>
<h3><a class="anchor" id="autotoc_md33"></a>
Additional Bootstrapping Function Needed</h3>
<p>BMI models written in <b>C</b> should implement an extra "registration" function in order to be compatible with NextGen. By default, this registration function is expected to be: </p><pre class="fragment">Bmi* register_bmi(Bmi *model);
</pre><p> It is possible to configure a different name for the function within the NGen realization config, but the return type and parameter list must be as noted here.</p>
<p>The implemented function must set the member pointers of the passed <code><a class="el" href="struct_bmi.html">Bmi</a></code> struct to the appropriate analogous functions inside the model. E.g., the <code>initialize</code> member of the struct: </p><pre class="fragment">int (*initialize)(struct Bmi *self, const char *config_file)
</pre><p> needs to be set to the module's function the performs the BMI initialization. This will probably be something like: </p><pre class="fragment">static int Initialize (Bmi *self, const char *file)
</pre><p> So the registration function may look something like: </p><pre class="fragment">Bmi* register_bmi_cfe(Bmi *model) {
    if (model) {
        ...
        model-&gt;initialize = Initialize;
        ...
</pre><p> Full examples for how to write this registration function can be found in the local CFE BMI implementation, specifically in <a href="../extern/cfe/src/bmi_cfe.c">extern/cfe/src/bmi_cfe.c</a>, or in the official CSDMS <em>bmi-example-c</em> repo near the bottom of the <a href="https://github.com/csdms/bmi-example-c/blob/master/heat/bmi_heat.c">bmi-heat.c</a> file.</p>
<h4><a class="anchor" id="autotoc_md34"></a>
Why?</h4>
<p>This is needed both due to the design of the <b>C</b> language variant of BMI, and the limitations of C regarding duplication of function names. The latter becomes significant when more than one BMI C library is used at once. Even if that is actively the case, NextGen is designed to accomodate that case, so this requirement is in place.</p>
<p>Future versions of NextGen will provide alternative ways to declaratively configure function names from a BMI C library so they can individually be dynamically loaded.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
Multi-Module BMI Formulations</h1>
<p>It is possible to configure a formulation to be a combination of several different individual BMI module components. This is the <code>bmi_multi</code> formulation type.</p>
<p>As described in <a href="#required-parameters">Required Parameters</a>, a BMI <code>init_config</code> does not need to be specified for this formulation type, but a nested list of sub-formulation configs (in <code>modules</code>) does. Execution of a formulation time step update proceeds through each module in list order.</p>
<p>A few other items of note:</p>
<ul>
<li>there are some constraints on input and output variables of the sub-modules of a multi-module formulation<ul>
<li>output variables must be uniquely traceable<ul>
<li>there must not be any output variable from a sub-module for which there is another output variable in a different sub-module that has the same config-mapped alias</li>
<li>when nothing is set for a variable in <code>variables_names_map</code>, its alias is equal to its name</li>
<li>when this doesn't hold, a unique mapped alias must be configured for one of the two (i.e., either an alias added, or changed to something different)</li>
</ul>
</li>
<li>input variables must have previously-identified data providers<ul>
<li>every input variable must have its alias match a property from an output data source</li>
<li>one way this works is if the alias is equal to the name of an externally available forcing property (e.g., AORC read from file) defined before the sub-module</li>
<li>another way is if the input variable's alias matches the alias of an output variable from an earlier sub-module<ul>
<li>in this case, one sub-module's output serve as a later sub-modules input for each multi-module formulation update</li>
<li>since modules get executed in order of configuration, "earlier" and "later" are with respect to the order they are defined in the <code>modules</code> config list</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>the framework allows independent configuration of the <code>uses_forcing_file</code> property among the individual sub-formulations, although this is not generally recommended</li>
<li>configuration of <code>variables_names_map</code> maps a given variable to a variable name of the directly </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Aug 5 2021 14:55:24 for NGen by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
