<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NGen: BMI External Models</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NGen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_doc__b_m_i__m_o_d_e_l_s.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">BMI External Models </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#formulation-config">Formulation Config</a><ul>
<li><a href="#required-parameters">Required Parameters</a></li>
<li><a href="#optional-parameters">Optional Parameters</a></li>
</ul>
</li>
<li><a href="#bmi-models-written-in-c">BMI Models Written in C</a><ul>
<li><a href="#bmi-c-shared-library">BMI C Model As Shared Library</a></li>
<li><a href="#bmi-c-cfe-example">Example: CFE Shared Library</a></li>
<li><a href="#bmi-c-caveats">BMI C Caveats</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md21"></a>
Summary</h1>
<p>The basic outline of steps needed to work with an external BMI model is:</p><ul>
<li>Configure the main formulation/realization config properly for the catchments that will use the generalized BMI realization(s)</li>
<li>Make sure all the necessary model-specific BMI initialization files are valid and in place</li>
<li>Take appropriate steps to make model source files accessible as needed (e.g., making sure shared library files are in a known location)</li>
<li>Be aware of any model-language-specific caveats<ul>
<li><a href="#bmi-c-caveats">Caveats for C language models</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md22"></a>
Formulation Config</h1>
<p>The catchment entry in the formulation/realization config must be set to used the appropriate type for the associated BMI realization, via the formulation's <code>name</code> JSON element. E.g.: </p><pre class="fragment">  ...
  "cat-87": {
       "formulations": [
           {
               "name": "bmi_c",
               "params": { ... }
           }
       }
  ...
</pre><p> Valid name values for the currently implemented BMI formulation types are:</p>
<ul>
<li><code>bmi_c</code></li>
</ul>
<p>Because of the generalization of the interface to the model, the required and optional parameters for all the BMI formulation types are the same. <br  />
</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Required Parameters</h2>
<p>The following must be present in the formulation/realization JSON config for all catchment entries using the BMI formulation type:</p>
<ul>
<li><code>model_type_name</code><ul>
<li>string name for the particular backing model type</li>
<li>may not be utilized in all cases, but still required</li>
</ul>
</li>
<li><code>forcing_file</code><ul>
<li>string path to the forcing data file for the catchment</li>
<li>the <code>init_config</code> file below will likely reference this file also, and the two should properly correspond</li>
<li>this is needed in here so the realization can directly access things implicit in the file, like times, time step amounts, and time step sizes</li>
</ul>
</li>
<li><code>uses_forcing_file</code><ul>
<li>boolean indicating whether the backing BMI model is written to read input data from the forcing file (as opposed to receiving it via getters)</li>
</ul>
</li>
<li><code>init_config</code><ul>
<li>the string path to the BMI initialization config file for the catchment</li>
</ul>
</li>
<li><code>main_output_variable</code><ul>
<li>the string value of the primary output variable</li>
<li>this is the value that returned by the realization's <code>get_response()</code></li>
<li>the string must match an item return by the relevant variant of the BMI <code>get_output_var_names()</code> function</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md24"></a>
Optional Parameters</h2>
<ul>
<li><code>other_input_variables</code><ul>
<li>this may be provided to set certain model variables more directly after its <code>initialize</code> function</li>
<li>JSON structure should be one or more nested JSON nodes, keyed by the variable name, and with the variable values contained as a list</li>
<li>e.g., <code>"other_input_variables": {"ex_var_1": [0, 1, 2]}</code></li>
</ul>
</li>
<li><code>output_variables</code><ul>
<li>can specify the particular set and order of output variables to include in the realization's <code>get_output_line_for_timestep()</code> (and similar) function</li>
<li>JSON structure should be a list of strings</li>
<li>if not present, defaults to whatever it returned by the model's BMI <code>get_output_var_names()</code> function <em>the first time</em> it is invoked</li>
</ul>
</li>
<li><code>output_header_fields</code><ul>
<li>can specify the header strings to use for the realization's printed output (i.e., the value returned by <code>get_output_header_line()</code>)</li>
<li>JSON structure should be a list of strings</li>
<li>when not present, the literal variable names are used</li>
<li>when present, does not do any checking for ordering/correspondence compared to the output ordering of the variable values, so users must take care that ordering is consistent</li>
</ul>
</li>
<li><code>allow_exceed_end_time</code><ul>
<li>boolean value to specify whether a model is allowed to execute <code>Update</code> calls that go beyond its end time (or the max forcing data entry)</li>
<li>implied to be <code>false</code> by default</li>
</ul>
</li>
<li><code>fixed_time_step</code><ul>
<li>boolean value to indicate whether this model has a fixed time step size</li>
<li>implied to be <code>true</code> by default</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md25"></a>
BMI Models Written in C</h1>
<ul>
<li><a href="#bmi-c-model-as-shared-library">Model As Shared Library</a></li>
<li><a href="#bmi-c-cfe-example">Example</a></li>
<li><a href="#bmi-c-caveats">Caveats</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md26"></a>
BMI C Model As Shared Library</h2>
<p>For <b>C</b> models, the model must be packaged as a pre-compiled shared library. Several CMake cache variables must be configured for controlling whether to expect such a library and how to find it. These are found in, or must be added to, the <em>CMakeCache.txt</em> file in the build system directory:</p>
<ul>
<li><code>BMI_C_LIB_ACTIVE</code><ul>
<li>type: <code>BOOL</code></li>
<li>must be set to <code>ON</code> (or equivalent in CMake) for BMI C shared library functionality to be compiled and active</li>
</ul>
</li>
<li><code>BMI_C_LIB</code><ul>
<li>type: <code>FILEPATH</code></li>
<li>library target value used for linking</li>
<li>typically the compiled library file</li>
<li>when not set, can potentially be derived/found using <code>BMI_C_LIB_NAME</code> and <code>BMI_C_LIB_DIR</code></li>
</ul>
</li>
<li><code>BMI_C_LIB_NAME</code><ul>
<li>type: <code>STRING</code></li>
<li>must be set if <code>BMI_C_LIB_ACTIVE</code> is <code>ON</code> but <code>BMI_C_LIB</code> is not set</li>
<li>supplies the name for the shared library for use when finding</li>
</ul>
</li>
<li><code>BMI_C_LIB_DIR</code><ul>
<li>type: <code>STRING</code></li>
<li>may be set to provide an explicit path for CMake to use when attempting to find the library</li>
<li>only searched after "default" paths (e.g., those in <code>CMAKE_PREFIX_PATH</code>)</li>
</ul>
</li>
</ul>
<p>The CMake build system may need to be <a href="BUILDS_AND_CMAKE.md#regenerating">regenerated</a> after changing these settings.</p>
<p>See the CMake documentation on the <em><a href="https://cmake.org/cmake/help/latest/command/set.html">set</a></em> function or <a href="https://cmake.org/cmake/help/latest/manual/cmake-language.7.html#cmake-language-variables">variables</a> for more information on working with CMake variables.</p>
<p>When CMake is able to find the library for the given name, it will automatically set up <a href="../src/realizations/catchment/CMakeLists.txt">the dependent, internal, static library</a> to dynamically link to the external shared library at runtime. <br  />
</p>
<p>If <code>BMI_C_LIB_ACTIVE</code> is set to <code>ON</code>, but either <code>BMI_C_LIB_NAME</code> is not set or no library of that name can be found, builds for most (if not all) targets will fail.</p>
<p>See <a href="#only-one-generic-bmi-c-at-a-time">caveat</a> about only using one <b>C</b> BMI model at a time with the built-in realization.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
BMI C CFE Example</h2>
<p>An example implementation for an appropriate BMI model as a <b>C</b> shared library is provided in the project <a href="../extern/cfe">here</a>.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
BMI C Caveats</h2>
<ul>
<li><a href="#bmi-c-activatedeactivation-required-in-cmake-build">Activation/Deactivation in CMake Required</a></li>
<li><a href="#only-one-generic-bmi-c-at-a-time">Only One Generic BMI C at a Time</a></li>
<li><a href="#additional-bootstrapping-function-needed">Additional Bootstrapping Function Needed</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md29"></a>
BMI C Activate/Deactivation Required in CMake Build</h3>
<p>BMI C functionality will not work (i.e., will not be compiled or executable) unless set to be active in the CMake build. This requires setting the <code>BMI_C_LIB_ACTIVE</code> CMake cache variable to <code>ON</code> or <code>TRUE</code> (or equivalent). It will probably also be necessary to configure other settings, as <a href="#bmi-c-model-as-shared-library">described here</a>.</p>
<p>Conversely, built executables (and perhaps certain build targets) will not work if <code>BMI_C_LIB_ACTIVE</code> is <code>ON</code> but the configured shared library is not available.</p>
<h3><a class="anchor" id="autotoc_md30"></a>
Only One Generic BMI C at a Time</h3>
<p>At the time of this writing, NextGen can only support one generic external <b>C</b> BMI model library in use at a time. <br  />
</p>
<p>This strictly applies to using a model with the built-in generalized BMI realization, which is the only external <b>C</b> model integration currently supported. Other experimental strategies may be possible, but they currently are outside the scope of this doc and not (yet) officially supported.</p>
<h3><a class="anchor" id="autotoc_md31"></a>
Additional Bootstrapping Function Needed</h3>
<p>BMI models written in <b>C</b> must provide one extra function in order to be compatible with NextGen: </p><pre class="fragment">Bmi* register_bmi(Bmi *model);
</pre><p> This function must set the member pointers of the passed <code><a class="el" href="struct_bmi.html">Bmi</a></code> struct param to the appropriate analogous functions. E.g., the <code>initialize</code> member of the the model, defined fully as: </p><pre class="fragment">int (*initialize)(struct Bmi *self, const char *config_file)
</pre><p> needs to be set to the function for initializing models. This will probably be something like:</p>
<p>static int Initialize (<a class="el" href="struct_bmi.html">Bmi</a> *self, const char *file)</p>
<h4><a class="anchor" id="autotoc_md32"></a>
Why?</h4>
<p>In the <b>C</b> language variant of BMI, the interface is provided by the <code><a class="el" href="struct_bmi.html">Bmi</a></code> struct definition, with it essentially having function pointers as its members. However, because of the nature of <b>C</b>, the struct definition cannot provide implementations for the functions themselves.</p>
<p>This is easy enough to remedy via a bootstrapping function that assigns function implementations to the pointer for a particular <code><a class="el" href="struct_bmi.html">Bmi</a></code> struct instance. This function is not strictly part of the BMI spec, though, but it is necessary to have a BMI <b>C</b> model work using the generic NextGen realization. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Mar 2 2021 20:12:20 for NGen by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
